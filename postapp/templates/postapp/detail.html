{% extends "postapp/base.html" %}
{% block content %}
{% load staticfiles %}
<script>
  function CatDelete() {
    location.replace("/detail/{{cat.pk}}/delete");
  }
</script>
<!-- 투표 입력시 이름 미기재, 중복이름 처리 -->
<script>
  function check_error() {
    const name = $("#newname_input");
    // console.log(name.val())

    const choices_string = "{{ choices_name }}".replace(/&#39;/g, "\"");
    const choices_name = JSON.parse(choices_string)
    //arow function
    choices_name.map((choice) => {
      if (name.val().trim() == choice['name']) {
        alert("이미 존재하는 이름입니다.");
      } else {
        $(newname_form).submit();
      }
    })
    if (name.val().trim().length === 0) {
      alert("이름을 입력하세요");
    } else {
      $(newname_form).submit();
    }
  }
</script>
<script>
  function count_overlap() {
    const max_name_string = "{{max_name}}".replace(/&#39;/g, "\"");
    const max_name = JSON.parse(max_name_string);
    // console.log(max_name);
    if (max_name.length > 1) {
      alert("동일 표가 있습니다.");
    } else {
      location.replace("/votecondition/{{cat.pk}}");
    }
  }
</script>
<div class="container">
  <!-- <h1>Detail</h1> -->
  <div class="row">
    <section id="maincontent">
      <div class="container">
        <div class="row">
          <div class="span12">
            <article>
              <div class="cat_delete_edit_bar">
                <div style="display: flex">
                  {% if cat.voting %}<div id="app" style="margin-left: 15px;"></div>{%endif%}
                </div>
                <div style="display: flex;">
                  <!-- <a href="{% url 'delete' cat.id %}" style="margin-right: 10px;">Delete<ion-icon name="trash"></ion-icon></a> -->
                  <a href="#" data-toggle="modal"
                  data-target="#myModal"  style="margin-right: 10px;">Delete<ion-icon name="trash"></ion-icon></a>
                  


                  <a href="{% url 'edit' cat.id %}">Edit<ion-icon name="create"></ion-icon></a>
                </div>
              </div>
              <div class="clearfix">
              </div>
              <div class="row">
                <div class="span8 cat-info-left">
                  <div class="cat_image_container">
                    <img class="cat_image" src="{{ cat.image.url }}" alt="" />
                  </div>
                  <div class="project-widget">
                      <h4><ion-icon name="pricetags"></ion-icon>Name: {{cat.name}} </h4>
                      <ul class="project-detail">
                        <li></li>
                      </ul>
                  </div>
                  <div class="project-widget cat-body-container">
                      <h4><ion-icon name="information-circle-outline"></ion-icon> Cat Info</h4>
                      <ul class="project-detail">
                        <li>
                          <div class="cat-body">
                            {{cat.body}}
                          </div>
                        </li>
                      </ul>
                  </div>
                  
                </div>
                <div>
                </div>
                <div class="span4">
                  <div class="project-widget ">
                    <h4><i class="icon-48 icon-beaker"></i> Cat Info</h4>
                    <ul class="project-detail">
                      <li><label>마지막 식사 :</label> {{ cat.lasteat | date:'Y-m-d H:i' }} <a href="/feed/{{ cat.pk }}"
                          class="btn btn-secondary">밥줬어요.</a></li>
                    </ul>
                  </div>

                  <div class="project-widget">
                    <h4><i class="icon-48 icon-map-marker"></i>Habitat</h4>
                    <form action="{% url 'addhabitat' num=cat.pk %}" method="post">
                      {% csrf_token %}
                      <ul class="project-detail">
                        <li><label>발견지역들 클릭한 후 제출!</label><button type="submit" class="btn btn-secondary"
                            style="margin-left:10px;">제출</button></li>
                        <input id="position_string" type="text" name="position_string" style="display:none;">
                        <li>
                          <div id="map" style="width:100%;height:300px;"></div><a onclick="removeCircles()"
                            class="btn btn-secondary">변경내용 모두삭제</a>
                        </li>
                      </ul>
                    </form>
                  </div>
                  <div class="project-widget ">
                      <h4><ion-icon name="checkmark-circle-outline"></ion-icon> Name Vote</h4>
                      <ul class="project-detail">
                        <li>성빈아 여기는 너가 해줘야해 어느 정도 공간이 필요할지 몰라서 너가 넣으면 높이 다시 맞출께</li>
                      </ul>
                  </div>
                </div>
              </div>
            </article>
            <!-- end article full post -->
          </div>
        </div>
      </div>
    </section>
    <!--  -->
  </div>


  <!-- kakao map -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=94d0a2f58c194ef47c239fd937aaaac4"></script>
  <script type="text/javascript">
    const pos_string = "{{pos}}".replace(/&#39;/g, "\"");
    // console.log(pos_string)
  </script>
  <script type="text/javascript" src="{%static 'kakaomap.js' %}"></script>
  <div class="vote">
    <!-- 나중에 투표종료를 누르면 Vote의 객체를 없애서 투표창을없애주도록 하자. -->
    {% if vote %}
    <p>투표 내용입니다.</p>
    <!-- 투표의 내용 -->
    {% else %}
    <p>현재 투표가 없습니다.</p>
    <!-- 투표를 새로 시작하는 창 -->
    {% endif %}




    {% if not cat.voting %}
    <div class="row">
      <p>새 이름을 지어줄까요?</p>
      <a href="/votecondition/{{ cat.pk }}" class="btn btn-success">네</a>
    </div>
    {% else %}
    <p>투표 진행중</p>
    <!-- 이름 투표 테이블 -->
    <table class="table table-striped">
      <thead>
        <tr>
          <td><B>이름</B></td>
          <td><B>투표수</B></td>
          <td><B>지지하기</B></td>
          <td><B>삭제</B></td>
        </tr>
      </thead>

      {% for choice in choices  %}
      <tbody>
        <tr>
          <td id="cat_name">{{choice.name}}</td>
          <td>{{choice.count}}</td>
          <td>
            <form action="{%url 'vote' vote.id%}" method="POST">
              {% csrf_token %}
              <button name="choice" value="{{choice.id}}">선택</button>
            </form>
          </td>
          <td>
            <a href="{% url 'delete_choice' cat.id choice.id %}">
              <ion-icon name="trash"></ion-icon>
            </a>
          </td>
        </tr>
      </tbody>
      {% endfor %}
    </table>
    <form id="newname_form" action="{% url 'add_name' cat.id%}">
      <input id="newname_input" type="text" name="add_name">
      <input onclick="check_error()"  class="btn btn-secondary" value="새 이름 추가하기" style="width: 100px;">

      <p id="no_name_error" style="display: none;">글씨입력하세요</p>
    </form>

    <!-- <a href="/votecondition/{{cat.pk}}" class="btn btn-success" onclick="count_overlap()">투표 종료</a> -->
    <a href="#" class="btn btn-success" onclick="count_overlap()">투표 종료</a>
    {% endif %}
  </div>
  <br><br>
  <form action="{% url 'comment_write' cat.id %}" method="POST">
    {% csrf_token %}
    <!-- <input type="text" name="content" placeholder="댓글을 입력하세요." style="width:800px;height:200px;"> -->
    <textarea name="content" cols="150" rows="4" placeholder="댓글을 입력하세요." style="resize:none;width:90%;"></textarea>
    <input type="submit" value="댓글쓰기">
  </form>
  

  {% for comment in cat.comment_set.all %}
  <div class="row">
    <div class="col-sm-6">
      <div class="comment">
        <div class="comment-body">
          <div class="comment-content">
            <div class="comment-content-first-row">
              <div>
                <ion-icon name="contact" style="width:20px;height:20px;margin-top:4px;"></ion-icon>
              </div>
              <h5 class="comment-title">유저이름</h5>
            </div>
            <h6>{{comment.comment_date | date:'Y-m-d'}}</h6>
            <p class="comment-text">{{comment.comment_contents}}</p>
          </div>
          <div class="comment-delete">
            <a href="{% url 'comment_delete' cat.id comment.id %}">
              <ion-icon name="close"></ion-icon>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <hr>
  
  {% endfor %}
  
  <div id="myModal" class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">UOSCAT</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>진짜로 내용을 삭제하시겠습니까?</p>
        </div>
        <div class="modal-footer">
          <button onclick="CatDelete()" type="button" class="btn btn-primary">삭제하기</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">취소하기</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- choices to json -->
<script>
    {% if choices_exist %}
    
    const str =
      "[{% for choice in choices %}{\"name\":\"{{choice.name}}\",\"id\":{{choice.id}},\"count\":{{choice.count}},\"vote_url\":\"{%url 'vote' vote.id%}\",\"delete_url\":\"{%url 'delete_choice' cat.id choice.id %}\"},{%endfor%}]"; 
    {% else %}
    const str = ''; 
    {% endif %}
    const add_url = "{% url 'add_name' cat.id%}";
  </script>

<script type="text/javascript" src="{%static './choices_voting.js' %}"></script>

<!-- add react -->
<script crossorigin src="https://unpkg.com/react@16/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>

<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<!-- axios -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!-- components -->
<script type="text/babel" src="{%static 'components/Board.js'%}"></script>
<script type="text/babel" src="{%static 'components/FormDialog.js'%}"></script>
<script type="text/babel" src="{%static 'components/DOM_render.js'%}"></script>
<!-- material ui -->
<script src="https://unpkg.com/@material-ui/core/umd/material-ui.production.min.js" crossorigin="anonymous"></script>

{% endblock %}